{"version":3,"file":"index.js","sources":["../../src/utils/index.ts"],"sourcesContent":["import { InputSelection, PrismEditor } from \"../index.js\"\r\nimport { numLines, isChrome, isWebKit } from \"../core.js\"\r\nimport { addListener, getLineEnd, getLineStart } from \"./local.js\"\r\n\r\nlet prevSelection: InputSelection | 0\r\n\r\n/** Escapes all special regex characters with a backslash and returns the escaped string. */\r\nconst regexEscape = (str: string) => str.replace(/[$+?|.^*()[\\]{}\\\\]/g, \"\\\\$&\")\r\n\r\n/** Returns the string between the position and the previous \\n. */\r\nconst getLineBefore = (text: string, position: number) =>\r\n\ttext.slice(getLineStart(text, position), position)\r\n\r\n/**\r\n * Gets all lines that are at least partially between `start` and `end`.\r\n * @param text Text to search in.\r\n * @param start Start of the selection.\r\n * @param end End of the selection. Defaults to `start`.\r\n * @returns A tuple containing an array of lines, the starting position of the first line,\r\n * and the ending position of the last line.\r\n */\r\nconst getLines = (text: string, start: number, end = start) =>\r\n\t[\r\n\t\ttext.slice((start = getLineStart(text, start)), (end = getLineEnd(text, end))).split(\"\\n\"),\r\n\t\tstart,\r\n\t\tend,\r\n\t] as const\r\n\r\n/**\r\n * Searches a full line for a token that matches a selector and contains `position`\r\n * within the specified margins. Tokens are searched in reverse document order which means\r\n * children are searched before their parents.\r\n * @param editor Editor you want to search in.\r\n * @param selector CSS selector for the tokens you want to search for.\r\n * @param marginLeft How far to the left of the token the position can be. Defaults to 0.\r\n * @param marginRight How far to the right of the token the position can be. Defaults to `marginLeft`.\r\n * @param position Position to search in. Defaults to `selectionStart`.\r\n * @returns A span element if one's found or undefined if not.\r\n * @example\r\n * This will return a string token if the cursor\r\n * is at least 1 character inside a string token\r\n * ```javascript\r\n * getClosestToken(editor, '.string', -1)\r\n * ```\r\n */\r\nconst getClosestToken = (\r\n\teditor: PrismEditor,\r\n\tselector: string,\r\n\tmarginLeft = 0,\r\n\tmarginRight = marginLeft,\r\n\tposition = editor.getSelection()[0],\r\n) => {\r\n\tconst value = editor.value\r\n\tconst line = editor.wrapper.children[numLines(value, 0, position)]\r\n\t// We unfortunitely have to include elements, else we can't get empty tokens\r\n\tconst walker = document.createTreeWalker(line, 5)\r\n\r\n\tlet node = walker.lastChild()\r\n\tlet offset = getLineEnd(value, position) + 1 - position - (<Text>node).length\r\n\r\n\twhile (-offset <= marginRight && (node = walker.previousNode())) {\r\n\t\tif (node.lastChild) continue\r\n\t\toffset -= (<Text>node).length || 0\r\n\r\n\t\tif (offset <= marginLeft) {\r\n\t\t\tfor (; node != line; node = node.parentNode!) {\r\n\t\t\t\tif ((<Element>node).matches?.(selector)) return <HTMLSpanElement>node\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * Gets the current language at a position.\r\n * Useful if you want to run different logic based on the language.\r\n * @param editor Editor to search in.\r\n * @param position Position to search in. Defaults to `selectionStart`.\r\n */\r\nconst getLanguage = (editor: PrismEditor, position?: number) =>\r\n\tgetClosestToken(editor, '[class*=\"language-\"]', 0, 0, position)?.className.match(\r\n\t\t/language-(\\S*)/,\r\n\t)![1] || editor.options.language\r\n\r\n/**\r\n * Inserts text into the editor (unless it's read-only) while keeping undo/redo history.\r\n * Focuses the `textarea` if it isn't already.\r\n * @param editor Target editor.\r\n * @param text Text to insert.\r\n * @param start Position to start the insertion. Defaults to `selectionStart`.\r\n * @param end Position to end the insertion. Defaults to `start` if specified, else `selectionEnd`.\r\n * @param newCursorStart New starting position for the cursor. Defaults to the end of the inserted text.\r\n * @param newCursorEnd New ending position for the cursor. Defaults to `newCursorStart`.\r\n */\r\nconst insertText = (\r\n\teditor: PrismEditor,\r\n\ttext: string,\r\n\tstart?: number | null,\r\n\tend?: number | null,\r\n\tnewCursorStart?: number | null,\r\n\tnewCursorEnd?: number | null,\r\n) => {\r\n\tif (editor.options.readOnly) return\r\n\tprevSelection = editor.getSelection()\r\n\tend ??= start\r\n\r\n\tlet textarea = editor.textarea\r\n\tlet value = editor.value\r\n\t// Bug inserting new lines at the end if the editor ends with an empty line\r\n\tlet avoidBug =\r\n\t\tisChrome && !value[end ?? prevSelection[1]] && /\\n$/.test(text) && /^$|\\n$/.test(value)\r\n\tlet removeListener: () => any\r\n\r\n\teditor.focused || textarea.focus()\r\n\tif (start != null) textarea.setSelectionRange(start, end!)\r\n\r\n\tif (newCursorStart != null) {\r\n\t\tremoveListener = addListener(editor, \"update\", () => {\r\n\t\t\ttextarea.setSelectionRange(\r\n\t\t\t\tnewCursorStart,\r\n\t\t\t\tnewCursorEnd ?? newCursorStart,\r\n\t\t\t\t(<InputSelection>prevSelection)[2],\r\n\t\t\t)\r\n\t\t\tremoveListener()\r\n\t\t})\r\n\t}\r\n\r\n\t// Only Safari dispatches a beforeinput event\r\n\tisWebKit || textarea.dispatchEvent(new InputEvent(\"beforeinput\", { data: text }))\r\n\r\n\t// Inserting escaped HTML in Chrome and Safari instead for much better performance\r\n\tif (isChrome || isWebKit) {\r\n\t\tif (avoidBug) {\r\n\t\t\t// This means the last new line won't be inserted if there's\r\n\t\t\t// no selection, but that's less annoying than the bug.\r\n\t\t\ttextarea.selectionEnd--\r\n\t\t\ttext = text.slice(0, -1)\r\n\t\t}\r\n\t\t// New line at the end is always ignored in Safari\r\n\t\tif (isWebKit) text += \"\\n\"\r\n\t\tdocument.execCommand(\r\n\t\t\ttext ? \"insertHTML\" : \"delete\",\r\n\t\t\tfalse,\r\n\t\t\ttext.replace(/&/g, \"&amp;\").replace(/</g, \"&lt;\"),\r\n\t\t)\r\n\t\tif (avoidBug) textarea.selectionStart++\r\n\t} else document.execCommand(text ? \"insertText\" : \"delete\", false, text)\r\n\r\n\tprevSelection = 0\r\n}\r\n\r\n/**\r\n * Returns a 4 bit integer where each bit represents whether\r\n * each modifier is pressed in the order Shift, Meta, Ctrl, Alt\r\n * ```javascript\r\n * e.altKey && e.ctrlKey && e.shiftKey && !e.metaKey\r\n * // is equivalent to\r\n * getModifierCode(e) == 0b1011\r\n * ```\r\n */\r\nconst getModifierCode = (\r\n\te: KeyboardEvent, // @ts-expect-error\r\n): number => e.altKey + e.ctrlKey * 2 + e.metaKey * 4 + e.shiftKey * 8\r\n\r\nexport {\r\n\tregexEscape,\r\n\tgetLineBefore,\r\n\tgetLines,\r\n\tgetClosestToken,\r\n\tgetLanguage,\r\n\tinsertText,\r\n\tgetModifierCode,\r\n\tprevSelection,\r\n}\r\n"],"names":[],"mappings":";;AAII,IAAA;AAGJ,MAAM,cAAc,CAAC,QAAgB,IAAI,QAAQ,uBAAuB,MAAM;AAGxE,MAAA,gBAAgB,CAAC,MAAc,aACpC,KAAK,MAAM,aAAa,MAAM,QAAQ,GAAG,QAAQ;AAUlD,MAAM,WAAW,CAAC,MAAc,OAAe,MAAM,UACpD;AAAA,EACC,KAAK,MAAO,QAAQ,aAAa,MAAM,KAAK,GAAK,MAAM,WAAW,MAAM,GAAG,CAAE,EAAE,MAAM,IAAI;AAAA,EACzF;AAAA,EACA;AACD;AAmBD,MAAM,kBAAkB,CACvB,QACA,UACA,aAAa,GACb,cAAc,YACd,WAAW,OAAO,aAAa,EAAE,CAAC,MAC9B;AACJ,QAAM,QAAQ,OAAO;AACf,QAAA,OAAO,OAAO,QAAQ,SAAS,SAAS,OAAO,GAAG,QAAQ,CAAC;AAEjE,QAAM,SAAS,SAAS,iBAAiB,MAAM,CAAC;AAE5C,MAAA,OAAO,OAAO;AAClB,MAAI,SAAS,WAAW,OAAO,QAAQ,IAAI,IAAI,WAAkB,KAAM;AAEvE,SAAO,CAAC,UAAU,gBAAgB,OAAO,OAAO,iBAAiB;AAChE,QAAI,KAAK;AAAW;AACpB,cAAiB,KAAM,UAAU;AAEjC,QAAI,UAAU,YAAY;AACzB,aAAO,QAAQ,MAAM,OAAO,KAAK,YAAa;AAC/B,YAAA,KAAM,UAAU,QAAQ;AAA2B,iBAAA;AAAA,MAClE;AAAA,IACD;AAAA,EACD;AACD;AAQM,MAAA,cAAc,CAAC,QAAqB,aACzC,gBAAgB,QAAQ,wBAAwB,GAAG,GAAG,QAAQ,GAAG,UAAU;AAAA,EAC1E;AACD,EAAG,CAAC,KAAK,OAAO,QAAQ;AAYzB,MAAM,aAAa,CAClB,QACA,MACA,OACA,KACA,gBACA,iBACI;AACJ,MAAI,OAAO,QAAQ;AAAU;AAC7B,kBAAgB,OAAO;AACf,gBAAA;AAER,MAAI,WAAW,OAAO;AACtB,MAAI,QAAQ,OAAO;AAEnB,MAAI,WACH,YAAY,CAAC,MAAM,OAAO,cAAc,CAAC,CAAC,KAAK,MAAM,KAAK,IAAI,KAAK,SAAS,KAAK,KAAK;AACnF,MAAA;AAEG,SAAA,WAAW,SAAS;AAC3B,MAAI,SAAS;AAAe,aAAA,kBAAkB,OAAO,GAAI;AAEzD,MAAI,kBAAkB,MAAM;AACV,qBAAA,YAAY,QAAQ,UAAU,MAAM;AAC3C,eAAA;AAAA,QACR;AAAA,QACA,gBAAgB;AAAA,QACC,cAAe,CAAC;AAAA,MAAA;AAEnB;IAAA,CACf;AAAA,EACF;AAGY,cAAA,SAAS,cAAc,IAAI,WAAW,eAAe,EAAE,MAAM,KAAM,CAAA,CAAC;AAGhF,MAAI,YAAY,UAAU;AACzB,QAAI,UAAU;AAGJ,eAAA;AACF,aAAA,KAAK,MAAM,GAAG,EAAE;AAAA,IACxB;AAEI,QAAA;AAAkB,cAAA;AACb,aAAA;AAAA,MACR,OAAO,eAAe;AAAA,MACtB;AAAA,MACA,KAAK,QAAQ,MAAM,OAAO,EAAE,QAAQ,MAAM,MAAM;AAAA,IAAA;AAE7C,QAAA;AAAmB,eAAA;AAAA,EACxB;AAAO,aAAS,YAAY,OAAO,eAAe,UAAU,OAAO,IAAI;AAEvD,kBAAA;AACjB;AAWA,MAAM,kBAAkB,CACvB,MACY,EAAE,SAAS,EAAE,UAAU,IAAI,EAAE,UAAU,IAAI,EAAE,WAAW;"}
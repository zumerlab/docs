{"version":3,"file":"cursor.js","sources":["../../src/extensions/cursor.ts"],"sourcesContent":["/** @module cursor */\r\n\r\nimport { BasicExtension, InputSelection, PrismEditor } from \"../index.js\"\r\nimport { createTemplate, addTextareaListener } from \"../core.js\"\r\nimport { getLineBefore } from \"../utils/index.js\"\r\nimport { getLineEnd, scrollToEl } from \"../utils/local.js\"\r\nimport { defaultCommands } from \"./commands.js\"\r\n\r\n/** Postion of the cursor relative to the editors overlays. */\r\nexport type CursorPosition = {\r\n\ttop: number\r\n\tbottom: number\r\n\tleft: number\r\n\tright: number\r\n\theight: number\r\n}\r\n\r\nexport interface Cursor extends BasicExtension {\r\n\t/** Gets the cursor position relative to the editor overlays. */\r\n\tgetPosition(): CursorPosition\r\n\t/** Scrolls the cursor into view. */\r\n\tscrollIntoView(): void\r\n\t/** The empty span element representing the cursor. */\r\n\telement: HTMLSpanElement\r\n}\r\n\r\nconst cursorTemplate = createTemplate(\r\n\t'<div style=position:absolute;top:0;opacity:0;padding:inherit> <span><span></span> ',\r\n)\r\n\r\n/**\r\n * Extension which can be used to calculate the position of the cursor and scroll it into view.\r\n * This is used by the {@link defaultCommands} extension to keep the cursor in view while typing.\r\n * \r\n * The extension can also be accessed from `editor.extensions.cursor` when added.\r\n */\r\nexport const cursorPosition = () => {\r\n\tlet cEditor: PrismEditor\r\n\tlet prevBefore = \" \"\r\n\tlet prevAfter = \" \"\r\n\r\n\tconst cursorContainer = cursorTemplate()\r\n\tconst [before, span] = <[Text, HTMLSpanElement]>(<unknown>cursorContainer.childNodes)\r\n\tconst [cursor, after] = <[HTMLSpanElement, Text]>(<unknown>span.childNodes)\r\n\tconst selectionChange = (selection: InputSelection) => {\r\n\t\tlet { value, activeLine } = cEditor\r\n\t\tlet position = selection[selection[2] < \"f\" ? 0 : 1]\r\n\t\tlet newBefore = getLineBefore(value, position)\r\n\t\tlet newAfter = value.slice(position, getLineEnd(value, position))\r\n\r\n\t\tif (!newBefore && !newAfter) newAfter = \" \"\r\n\t\tif (prevBefore != newBefore) before.data = prevBefore = newBefore\r\n\t\tif (prevAfter != newAfter) after.data = prevAfter = newAfter\r\n\t\tif (cursorContainer.parentNode != activeLine) activeLine.prepend(cursorContainer)\r\n\t}\r\n\tconst scrollIntoView = () => scrollToEl(cEditor, cursor)\r\n\r\n\tconst self: Cursor = editor => {\r\n\t\teditor.addListener(\"selectionChange\", selectionChange)\r\n\t\tcEditor = editor\r\n\r\n\t\teditor.extensions.cursor = self\r\n\t\taddTextareaListener(editor, \"input\", e => {\r\n\t\t\tif (/history/.test((<InputEvent>e).inputType)) scrollIntoView()\r\n\t\t})\r\n\r\n\t\tif (editor.activeLine) selectionChange(editor.getSelection())\r\n\t}\r\n\r\n\tself.getPosition = () => {\r\n\t\tconst rect1 = cursor.getBoundingClientRect()\r\n\t\tconst rect2 = cEditor.overlays.getBoundingClientRect()\r\n\r\n\t\treturn {\r\n\t\t\ttop: rect1.y - rect2.y,\r\n\t\t\tbottom: rect2.bottom - rect1.bottom,\r\n\t\t\tleft: rect1.x - rect2.x,\r\n\t\t\tright: rect2.right - rect1.x,\r\n\t\t\theight: rect1.height,\r\n\t\t}\r\n\t}\r\n\r\n\tself.scrollIntoView = scrollIntoView\r\n\tself.element = cursor\r\n\r\n\treturn self\r\n}\r\n"],"names":[],"mappings":";;;AA0BA,MAAM,iBAAiB;AAAA,EACtB;AACD;AAQO,MAAM,iBAAiB,MAAM;AAC/B,MAAA;AACJ,MAAI,aAAa;AACjB,MAAI,YAAY;AAEhB,QAAM,kBAAkB;AACxB,QAAM,CAAC,QAAQ,IAAI,IAAuC,gBAAgB;AAC1E,QAAM,CAAC,QAAQ,KAAK,IAAuC,KAAK;AAC1D,QAAA,kBAAkB,CAAC,cAA8B;AAClD,QAAA,EAAE,OAAO,WAAe,IAAA;AAC5B,QAAI,WAAW,UAAU,UAAU,CAAC,IAAI,MAAM,IAAI,CAAC;AAC/C,QAAA,YAAY,cAAc,OAAO,QAAQ;AAC7C,QAAI,WAAW,MAAM,MAAM,UAAU,WAAW,OAAO,QAAQ,CAAC;AAE5D,QAAA,CAAC,aAAa,CAAC;AAAqB,iBAAA;AACxC,QAAI,cAAc;AAAW,aAAO,OAAO,aAAa;AACxD,QAAI,aAAa;AAAU,YAAM,OAAO,YAAY;AACpD,QAAI,gBAAgB,cAAc;AAAY,iBAAW,QAAQ,eAAe;AAAA,EAAA;AAEjF,QAAM,iBAAiB,MAAM,WAAW,SAAS,MAAM;AAEvD,QAAM,OAAe,CAAU,WAAA;AACvB,WAAA,YAAY,mBAAmB,eAAe;AAC3C,cAAA;AAEV,WAAO,WAAW,SAAS;AACP,wBAAA,QAAQ,SAAS,CAAK,MAAA;AACrC,UAAA,UAAU,KAAkB,EAAG,SAAS;AAAkB;IAAA,CAC9D;AAED,QAAI,OAAO;AAA4B,sBAAA,OAAO,cAAc;AAAA,EAAA;AAG7D,OAAK,cAAc,MAAM;AAClB,UAAA,QAAQ,OAAO;AACf,UAAA,QAAQ,QAAQ,SAAS,sBAAsB;AAE9C,WAAA;AAAA,MACN,KAAK,MAAM,IAAI,MAAM;AAAA,MACrB,QAAQ,MAAM,SAAS,MAAM;AAAA,MAC7B,MAAM,MAAM,IAAI,MAAM;AAAA,MACtB,OAAO,MAAM,QAAQ,MAAM;AAAA,MAC3B,QAAQ,MAAM;AAAA,IAAA;AAAA,EACf;AAGD,OAAK,iBAAiB;AACtB,OAAK,UAAU;AAER,SAAA;AACR;"}